<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™‚å…‰è¡Œè€…ï¼šç§¦æ¼¢é¢¨é›² (é‡è£½å¢å¼·ç‰ˆ)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.development.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.development.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=DotGothic16&family=Noto+Serif+TC:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* åŸºç¤æ¨£å¼ */
        body {
            font-family: 'DotGothic16', 'Noto Serif TC', monospace;
            background-color: #222034;
            color: #E8E8E8;
            overflow-x: hidden;
            background-image: repeating-linear-gradient(45deg, #3b3a5d 0, #3b3a5d 1px, #222034 1px, #222034 5px);
            min-height: 100vh;
        }

        .game-container {
            border: 4px solid #5C5B7F;
            box-shadow: 8px 8px 0px 0px #1A192A;
            background-color: #4B4B6F;
        }
        
        /* æŒ‰éˆ•ç‰¹æ•ˆ */
        .game-btn {
            background-color: #736E9B; 
            border: 3px solid #5C5B7F; 
            transition: all 0.1s;
            cursor: pointer;
            box-shadow: 4px 4px 0px 0px #1A192A;
            position: relative;
            overflow: hidden;
        }
        .game-btn:hover:not(:disabled) {
            background-color: #8C88B0;
            transform: translateY(-1px);
        }
        .game-btn:active:not(:disabled) {
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0px 0px #1A192A;
        }
        .game-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            filter: grayscale(100%);
        }

        /* é€²åº¦æ¢æ¨£å¼ */
        .stat-bar-bg {
            background-color: #222034;
            border: 2px solid #1A192A;
            height: 12px;
            border-radius: 6px;
            overflow: hidden;
        }
        .stat-bar-fill {
            height: 100%;
            transition: width 0.5s ease-out;
        }

        /* æµ®å‹•æ•¸å€¼å‹•ç•« */
        .float-text {
            position: absolute;
            animation: floatUp 1.5s ease-out forwards;
            font-weight: bold;
            pointer-events: none;
            z-index: 50;
            text-shadow: 1px 1px 0 #000;
        }
        @keyframes floatUp {
            0% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-30px); }
        }

        /* æ‰“å­—æ©Ÿå…‰æ¨™ */
        .cursor::after {
            content: 'â–‹';
            animation: blink 1s infinite;
        }
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }

        /* Modal é®ç½© */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(2px);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- 1. è³‡æ–™åº«èˆ‡é…ç½® (ä¿ç•™åŸæœ¬çš„çµæ§‹ï¼Œä¿®æ­£éƒ¨åˆ†åœ–ç‰‡é‚è¼¯) ---
        // ä½¿ç”¨ Placehold.co ä½œç‚ºé è¨­åœ–ç‰‡ï¼Œç¢ºä¿ä»£ç¢¼å¯ä»¥ç›´æ¥é‹è¡Œ
        const getPlaceholderUrl = (text) => `https://placehold.co/600x400/1a1a1a/FFF?text=${text}`;

        const SceneImages = {
            Classroom: getPlaceholderUrl("æ­·å²æ•™å®¤"),
            QinPalace: getPlaceholderUrl("å’¸é™½å®®"),
            GreatWall: getPlaceholderUrl("è¬é‡Œé•·åŸ"),
            War: getPlaceholderUrl("å¤ä»£æˆ°å ´"),
            Farm: getPlaceholderUrl("ç”°åœ’è¾²èˆ"),
            Desert: getPlaceholderUrl("è¥¿åŸŸæ²™æ¼ "),
            Study: getPlaceholderUrl("å¤ªå­¸"),
            Treasury: getPlaceholderUrl("åœ‹åº«"),
            Fire: getPlaceholderUrl("ç„šæ›¸ç«å…‰"),
            Prison: getPlaceholderUrl("å¤§ç‰¢"),
            Map: getPlaceholderUrl("åœ°åœ–"),
            Crown: getPlaceholderUrl("çš‡æ¬Š"),
        };

        const Icons = {
            Heart: () => <span>â¤ é«”åŠ›</span>,
            Brain: () => <span>ğŸ§  æ™ºåŠ›</span>,
            Coin: () => <span>ğŸ’° è²¡å¯Œ</span>,
            Star: () => <span>ğŸ‘‘ è²æœ›</span>,
        };

        // ... (ä¿ç•™ä½ åŸæœ¬çš„ historyQuizPool å’Œ storyNodesï¼Œç‚ºç¯€çœç¯‡å¹…é€™è£¡çœç•¥é‡è¤‡å®šç¾©ï¼Œç›´æ¥ä½¿ç”¨è®Šé‡å)
        // ç‚ºäº†ä»£ç¢¼èƒ½è·‘ï¼Œé€™è£¡æˆ‘éœ€è¦é‡æ–°å®šç¾©è®Šé‡ï¼Œå¯¦éš›ä½¿ç”¨æ™‚è«‹å°‡ä½ åŸæœ¬çš„é•·æ•¸æ“šè²¼å›ä¾†ã€‚
        // ç‚ºæ¼”ç¤ºæ–¹ä¾¿ï¼Œé€™è£¡åªåŒ…å«å¹¾å€‹é—œéµç¯€é»ã€‚
        
        const historyQuizPool = [
            { npc: "ææ–¯", role: "ç§¦æœä¸ç›¸", question: "å¾æè­°å»¢åˆ†å°ï¼Œè¡Œéƒ¡ç¸£ã€‚ä½ å¯çŸ¥ç§¦æœå°‡å¤©ä¸‹åˆ†ç‚ºå¤šå°‘éƒ¡ï¼Ÿ", options: ["åäºŒéƒ¡", "ä¸‰åå…­éƒ¡", "å››åå…«éƒ¡"], answer: 1, correctMsg: "ç„¶ä¹Ÿï¼é›†æ¬Šä¸­å¤®ã€‚", wrongMsg: "è¬¬çŸ£ï¼", reward: { knowledge: 10 }, penalty: { knowledge: -5 } },
            { npc: "èŠè»»", role: "åˆºå®¢", question: "é¢¨è•­è•­å…®æ˜“æ°´å¯’...", options: ["å£¯å£«ä¸€å»å…®ä¸å¾©é‚„", "å¤§é¢¨èµ·å…®é›²é£›æš"], answer: 0, correctMsg: "å¥½ï¼æ‡‚æˆ‘è€…ã€‚", wrongMsg: "ä¸æ‡‚é¢¨é›…ã€‚", reward: { health: 10 }, penalty: { reputation: -5 } }
        ];

        const storyNodes = {
            "intro": {
                id: "intro", title: "åºç« ï¼šæ­·å²çš„å¬å–š",
                text: "è¥¿å…ƒ2024å¹´ã€‚æ­·å²èª²ä¸Šï¼Œè€å¸«è¬›è¿°è‘—ï¼šã€Œç§¦çš‡æ¼¢æ­¦ï¼Œç•¥è¼¸æ–‡é‡‡...ã€ä½ çš„æ€ç·’é£„å‘äº†å…©åƒå¹´å‰çš„æ™‚ç©ºæ¼©æ¸¦ã€‚",
                image: "Classroom",
                options: [
                    { text: "èªçœŸè½èª²", nextId: "qin_war", effect: { knowledge: 10 }, feedback: "çŸ¥è­˜å°±æ˜¯åŠ›é‡ã€‚" },
                    { text: "ç¡è¦ºå„²å­˜é«”åŠ›", nextId: "qin_war", effect: { health: 10 }, feedback: "ç²¾ç¥é£½æ»¿åœ°ç©¿è¶Šäº†ã€‚" }
                ]
            },
            "qin_war": {
                id: "qin_war", title: "1. ç§¦æ»…å…­åœ‹ (BC 230)",
                text: "ä½ ç½®èº«æ–¼ç§¦è»å¤§å¸³ã€‚ç§¦ç‹å¬´æ”¿æ¬²ä¸€çµ±å¤©ä¸‹ï¼Œæ»…åœ‹ä¹‹æˆ°ä¸€è§¸å³ç™¼ã€‚",
                image: "War",
                options: [
                    { text: "ç»è¨ˆã€Œé äº¤è¿‘æ”»ã€", nextId: "qin_system", effect: { knowledge: 15, reputation: 10, health: -5 }, feedback: "ä½ çš„ç­–ç•¥åŠ é€Ÿäº†å…­åœ‹çš„æ»…äº¡ï¼" },
                    { text: "è¦ªä¸Šå‰ç·šæ®ºæ•µ", nextId: "qin_system", effect: { health: -10, wealth: 20, reputation: 5 }, feedback: "ä½ ç²å¾—äº†ç§¦åœ‹çš„è»åŠŸçˆµä½ã€‚" }
                ]
            },
             "qin_system": {
                id: "qin_system", title: "2. åˆ¶åº¦ä¹‹çˆ­",
                text: "å¤©ä¸‹åˆå®šï¼Œæœå»·ä¸Šæ­£åœ¨çˆ­è«–å¯¦è¡Œã€Œéƒ¡ç¸£åˆ¶ã€é‚„æ˜¯ã€Œåˆ†å°åˆ¶ã€ã€‚",
                image: "QinPalace",
                options: [
                    { text: "æ”¯æŒææ–¯(éƒ¡ç¸£)", nextId: "ending_calc", effect: { knowledge: 20 }, feedback: "ä¸­å¤®é›†æ¬Šç¢ºç«‹ï¼" },
                    { text: "æ”¯æŒç‹ç¶°(åˆ†å°)", nextId: "ending_calc", effect: { reputation: -10 }, feedback: "ç§¦å§‹çš‡é§å›äº†ä½ çš„å»ºè­°ã€‚" }
                ]
            },
            "ending_calc": { id: "ending_calc", title: "çµç®—ä¸­...", text: "æ­£åœ¨çµ±è¨ˆä½ çš„æ­·å²è©•åƒ¹...", isCalc: true, image: "Classroom" },
            // çµå±€èˆ‡éŠæˆ²çµæŸ
            "ending_emperor": { id: "ending_emperor", title: "çµå±€ï¼šåƒå¤ä¸€å¸", text: "ä½ çš„ç¶œåˆèƒ½åŠ›é”åˆ°äº†é ‚å³°ï¼", image: "QinPalace" },
            "ending_commoner": { id: "ending_commoner", title: "çµå±€ï¼šæ­¸éš±ç”°åœ’", text: "ä½ å¹³å®‰åº¦éäº†äº‚ä¸–ã€‚", image: "Farm" },
            "game_over": { id: "game_over", title: "å£¯å¿—æœªé…¬", text: "ä½ çš„é«”åŠ›è€—ç›¡äº†...", image: "Fire" }
        };

        // --- 2. å·¥å…·çµ„ä»¶ï¼šæ‰“å­—æ©Ÿæ•ˆæœ ---
        const Typewriter = ({ text, speed = 30, onComplete }) => {
            const [display, setDisplay] = useState("");
            const indexRef = useRef(0);

            useEffect(() => {
                setDisplay("");
                indexRef.current = 0;
                
                const timer = setInterval(() => {
                    if (indexRef.current < text.length) {
                        setDisplay((prev) => prev + text.charAt(indexRef.current));
                        indexRef.current++;
                    } else {
                        clearInterval(timer);
                        if (onComplete) onComplete();
                    }
                }, speed);

                return () => clearInterval(timer);
            }, [text]);

            return <span className={indexRef.current < text.length ? "cursor" : ""}>{display}</span>;
        };

        // --- 3. å·¥å…·çµ„ä»¶ï¼šå±¬æ€§æ¢ ---
        const StatBar = ({ icon: Icon, value, max = 100, color, label }) => (
            <div className="flex flex-col w-full mb-2">
                <div className="flex justify-between text-xs mb-1 text-gray-300">
                    <div className="flex items-center gap-1"><Icon /></div>
                    <span>{value}/{max}</span>
                </div>
                <div className="stat-bar-bg">
                    <div 
                        className="stat-bar-fill" 
                        style={{ width: `${Math.min(100, Math.max(0, (value / max) * 100))}%`, backgroundColor: color }}
                    ></div>
                </div>
            </div>
        );

        // --- 4. ä¸»éŠæˆ²çµ„ä»¶ ---
        const GameApp = () => {
            // ç‹€æ…‹ç®¡ç†
            const [currentNodeId, setCurrentNodeId] = useState("intro");
            const [stats, setStats] = useState({ health: 50, knowledge: 30, wealth: 30, reputation: 10 });
            const [historyLog, setHistoryLog] = useState([]);
            const [feedback, setFeedback] = useState("");
            const [floatingTexts, setFloatingTexts] = useState([]);
            const [isQuizActive, setIsQuizActive] = useState(false);
            const [currentQuiz, setCurrentQuiz] = useState(null);
            const [pendingNextId, setPendingNextId] = useState(null);
            const [textCompleted, setTextCompleted] = useState(false);

            const currentNode = storyNodes[currentNodeId] || storyNodes["intro"];

            // å­˜æª”åŠŸèƒ½
            useEffect(() => {
                const saved = localStorage.getItem("timeWalkerSave");
                if (saved) {
                    // å¯ä»¥æ·»åŠ ä¸€å€‹ "ç¹¼çºŒéŠæˆ²" çš„æŒ‰éˆ•é‚è¼¯ï¼Œé€™è£¡ç°¡åŒ–è™•ç†
                    console.log("Found save game");
                }
            }, []);

            const saveGame = () => {
                const saveData = { currentNodeId, stats, historyLog };
                localStorage.setItem("timeWalkerSave", JSON.stringify(saveData));
                showFloatText("å­˜æª”æˆåŠŸï¼", "text-green-400");
            };

            const resetGame = () => {
                localStorage.removeItem("timeWalkerSave");
                setCurrentNodeId("intro");
                setStats({ health: 50, knowledge: 30, wealth: 30, reputation: 10 });
                setHistoryLog([]);
                setFeedback("");
            };

            // é¡¯ç¤ºæµ®å‹•æ–‡å­—
            const showFloatText = (text, colorClass = "text-yellow-300") => {
                const id = Date.now();
                setFloatingTexts(prev => [...prev, { id, text, colorClass, x: Math.random() * 20 + 40 + '%', y: '50%' }]);
                setTimeout(() => {
                    setFloatingTexts(prev => prev.filter(ft => ft.id !== id));
                }, 1500);
            };

            // è™•ç†é¸é …é»æ“Š
            const handleOptionClick = (option) => {
                // 1. æª¢æŸ¥éœ€æ±‚
                if (option.reqHealth && stats.health < option.reqHealth) {
                    showFloatText("é«”åŠ›ä¸è¶³ï¼", "text-red-500");
                    return;
                }
                if (option.reqKnowledge && stats.knowledge < option.reqKnowledge) {
                    showFloatText("æ™ºåŠ›ä¸è¶³ï¼", "text-red-500");
                    return;
                }

                // 2. çµç®—å±¬æ€§
                if (option.effect) {
                    updateStats(option.effect);
                }

                // 3. è¨˜éŒ„æ­·å²
                setHistoryLog(prev => [...prev, { title: currentNode.title, choice: option.text }]);
                setFeedback(option.feedback);

                // 4. éš¨æ©Ÿè§¸ç™¼å•ç­” (20%æ©Ÿç‡ï¼Œä¸”ä¸æ˜¯çµç®—é é¢)
                const shouldTriggerQuiz = Math.random() < 0.3 && !option.nextId.includes("ending");
                
                if (shouldTriggerQuiz) {
                    const quiz = historyQuizPool[Math.floor(Math.random() * historyQuizPool.length)];
                    setCurrentQuiz(quiz);
                    setPendingNextId(option.nextId);
                    setIsQuizActive(true);
                } else {
                    changeScene(option.nextId);
                }
            };

            const changeScene = (nextId) => {
                // æª¢æŸ¥æ˜¯å¦éŠæˆ²çµæŸ
                if (stats.health <= 0 && nextId !== "intro") {
                    setCurrentNodeId("game_over");
                } else {
                    setCurrentNodeId(nextId);
                }
                setTextCompleted(false);
            };

            const updateStats = (effect) => {
                setStats(prev => {
                    const newStats = { ...prev };
                    Object.keys(effect).forEach(key => {
                        const val = effect[key];
                        newStats[key] = Math.max(0, Math.min(100, prev[key] + val));
                        
                        // è¦–è¦ºåé¥‹
                        const sign = val > 0 ? "+" : "";
                        const color = val > 0 ? "text-green-400" : "text-red-400";
                        const label = { health: "é«”åŠ›", knowledge: "æ™ºåŠ›", wealth: "è²¡å¯Œ", reputation: "è²æœ›" }[key];
                        showFloatText(`${label} ${sign}${val}`, color);
                    });
                    return newStats;
                });
            };

            // è™•ç†å•ç­”
            const handleQuizAnswer = (optionIndex) => {
                if (optionIndex === currentQuiz.answer) {
                    setFeedback(`ã€${currentQuiz.npc}ã€‘ï¼š${currentQuiz.correctMsg}`);
                    updateStats(currentQuiz.reward);
                } else {
                    setFeedback(`ã€${currentQuiz.npc}ã€‘ï¼š${currentQuiz.wrongMsg}`);
                    updateStats(currentQuiz.penalty);
                }
                setTimeout(() => {
                    setIsQuizActive(false);
                    changeScene(pendingNextId);
                }, 1500);
            };

            // è™•ç†çµå±€è¨ˆç®— (React Effect)
            useEffect(() => {
                if (currentNode.isCalc) {
                    setTimeout(() => {
                        // ç°¡å–®çš„çµå±€åˆ¤æ–·é‚è¼¯
                        let finalEnding = "ending_commoner";
                        const total = stats.knowledge + stats.wealth + stats.reputation;
                        
                        if (stats.reputation > 80 && stats.knowledge > 80) finalEnding = "ending_emperor";
                        else if (stats.knowledge > 90) finalEnding = "ending_scholar"; // éœ€è‡ªè¡Œè£œå……ç¯€é»
                        
                        setCurrentNodeId(finalEnding);
                    }, 2000);
                }
            }, [currentNode]);

            // --- æ¸²æŸ“éƒ¨åˆ† ---
            return (
                <div className="flex justify-center items-center min-h-screen p-4">
                    <div className="game-container w-full max-w-2xl rounded-lg p-6 relative">
                        
                        {/* æµ®å‹•æ–‡å­—å±¤ */}
                        {floatingTexts.map(ft => (
                            <div key={ft.id} className={`float-text ${ft.colorClass} text-xl`} style={{ left: ft.x, top: ft.y }}>
                                {ft.text}
                            </div>
                        ))}

                        {/* é ‚éƒ¨ç‹€æ…‹æ¬„ */}
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6 bg-[#353450] p-3 rounded-lg border-2 border-[#5C5B7F]">
                            <StatBar icon={Icons.Heart} value={stats.health} color="#e11d48" />
                            <StatBar icon={Icons.Brain} value={stats.knowledge} color="#3b82f6" />
                            <StatBar icon={Icons.Coin} value={stats.wealth} color="#eab308" />
                            <StatBar icon={Icons.Star} value={stats.reputation} color="#a855f7" />
                        </div>

                        {/* ä¸»åœ–ç‰‡å€ */}
                        <div className="w-full h-56 md:h-64 mb-6 relative border-4 border-[#2b2b2b] shadow-inner bg-[#1a1a1a] overflow-hidden group">
                            <img 
                                src={SceneImages[currentNode.image] || SceneImages.Classroom} 
                                alt="å ´æ™¯" 
                                className="w-full h-full object-cover transition-transform duration-1000 group-hover:scale-110"
                            />
                            {/* æ­·å²ç­†è¨˜ Tooltip å€åŸŸ (å¯é¸) */}
                        </div>

                        {/* æ–‡æœ¬å€åŸŸ */}
                        <div className="bg-[#2a283e] p-4 rounded border-2 border-[#5C5B7F] mb-6 min-h-[120px] shadow-inner">
                            <h2 className="text-xl text-[#F8F4A6] mb-2 font-bold flex justify-between">
                                <span>{currentNode.title}</span>
                                <span className="text-sm text-gray-400 cursor-pointer hover:text-white" onClick={saveGame}>[å­˜æª”]</span>
                            </h2>
                            <p className="text-lg leading-relaxed text-gray-200">
                                <Typewriter text={currentNode.text} onComplete={() => setTextCompleted(true)} />
                            </p>
                            {feedback && <div className="mt-3 text-[#7dd3fc] text-sm border-t border-gray-600 pt-2">ğŸ’¡ {feedback}</div>}
                        </div>

                        {/* é¸é …æŒ‰éˆ•å€ */}
                        <div className="grid gap-3">
                            {currentNode.options && currentNode.options.map((opt, idx) => (
                                <button
                                    key={idx}
                                    onClick={() => handleOptionClick(opt)}
                                    disabled={!textCompleted && !currentNode.isCalc}
                                    className="game-btn text-left p-4 rounded text-white font-bold flex justify-between items-center group disabled:opacity-50"
                                >
                                    <span className="flex-1">
                                        <span className="text-yellow-400 mr-2">{idx + 1}.</span>
                                        {opt.text}
                                    </span>
                                    {/* é¡¯ç¤ºéœ€æ±‚æç¤º */}
                                    <div className="text-xs font-normal text-gray-300 opacity-0 group-hover:opacity-100 transition-opacity">
                                        {opt.reqHealth && <span className="text-red-300 block">éœ€é«”åŠ› {opt.reqHealth}</span>}
                                        {opt.reqKnowledge && <span className="text-blue-300 block">éœ€æ™ºåŠ› {opt.reqKnowledge}</span>}
                                    </div>
                                </button>
                            ))}

                            {/* é‡ç©æŒ‰éˆ• */}
                            {(currentNodeId.startsWith("ending") || currentNodeId === "game_over") && (
                                <button onClick={resetGame} className="game-btn w-full p-4 mt-4 text-center text-yellow-300">
                                    â†º è¼ªè¿´é‡å•Ÿ (å†ä¾†ä¸€å±€)
                                </button>
                            )}
                        </div>

                        {/* NPC å•ç­” Modal */}
                        {isQuizActive && currentQuiz && (
                            <div className="absolute inset-0 z-50 flex items-center justify-center modal-overlay p-4 rounded-lg">
                                <div className="bg-[#2a283e] border-4 border-[#d4af37] p-6 rounded-lg max-w-sm w-full shadow-2xl animate-bounce-in">
                                    <div className="text-center mb-4">
                                        <div className="text-4xl mb-2">ğŸ“œ</div>
                                        <h3 className="text-xl text-[#d4af37] font-bold">çªç™¼äº‹ä»¶ï¼š{currentQuiz.npc}</h3>
                                        <p className="text-xs text-gray-400">{currentQuiz.role}</p>
                                    </div>
                                    <p className="mb-6 font-bold">{currentQuiz.question}</p>
                                    <div className="grid gap-2">
                                        {currentQuiz.options.map((opt, idx) => (
                                            <button 
                                                key={idx} 
                                                onClick={() => handleQuizAnswer(idx)}
                                                className="bg-[#4B4B6F] hover:bg-[#5C5B7F] p-3 rounded text-left text-sm border border-gray-600"
                                            >
                                                {String.fromCharCode(65 + idx)}. {opt}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        )}

                    </div>
                    
                    <footer className="fixed bottom-2 text-xs text-gray-500">
                        Designed for History Lovers
                    </footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<GameApp />);
    </script>
</body>
</html>
